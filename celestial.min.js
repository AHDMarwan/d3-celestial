// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t){return document.getElementById(t)}function a(t,a){var r=e(t.map(function(t){return t*o}),a);return r.map(function(t){return t/o})}function e(t,a){var e,r,n,l,o,f,c,u,d,g,p=1e-5;return a?(f=t[0],0>f&&(f+=s),c=t[1],f-=a[0],l=a[1],o=a[2],e=Math.sin(c)*Math.sin(l)-Math.cos(c)*Math.cos(l)*Math.cos(f),Math.abs(e)<p&&(e=-Math.cos(c+l)+Math.cos(c)*Math.cos(l)*(1-Math.cos(f))),r=-Math.cos(c)*Math.sin(f),u=0!==e||0!==r?Math.atan2(r,e):f-Math.PI,d=o+u,d>Math.PI&&(d-=s),f%Math.PI===0?(g=c+Math.cos(f)*l,g>i&&(g=Math.PI-g),-i>g&&(g=-Math.PI-g)):(n=Math.sin(c)*Math.cos(l)+Math.cos(c)*Math.sin(l)*Math.cos(f),Math.abs(n)>.99?(g=Math.abs(Math.acos(Math.sqrt(e*e+r*r))),0>n&&(g*=-1)):g=Math.asin(n)),[d,g]):t}var r={};r.display=function(a){function e(t){return j.clip&&d3.geo.distance(E,t)>i?0:1}function s(t){return"translate("+S(t)+")"}function o(){if(d3.event){var t=S.rotate();D.scale(S.scale()),z=7*Math.sqrt(S.scale()/j.scale),E=[-t[0],-t[1]],C.selectAll("path").attr("d",R.pointRadius(function(t){return t.properties?v(t.properties.mag):1})),C.selectAll("text").attr("transform",function(t){return s(t.geometry.coordinates)}).style("fill-opacity",function(t){return e(t.geometry.coordinates)}),C.selectAll(".dso").attr("transform",function(t){return s(t.geometry.coordinates)}).attr("d",function(t){return f(t.properties)}).style("fill-opacity",function(t){return e(t.geometry.coordinates)}).style("stroke-opacity",function(t){return e(t.geometry.coordinates)}),C.selectAll(".outline").attr("d",B)}}function f(t){var a=m(t.mag,t.dim)||9,e=p(t.type);return-1!==d3.svg.symbolTypes.indexOf(e)?d3.svg.symbol().type(e).size(a)():d3.svg.customSymbol().type(e).size(a)()}function p(t){return t&&u.hasOwnProperty(t)?u[t].shape:"circle"}function h(t,a){return!t.type||!u.hasOwnProperty(t.type)||999==t.mag&&Math.sqrt(parseInt(t.dim))<w.dsos.limit||999!=t.mag&&t.mag>w.dsos.limit?"":a?"fill:"+u[t.type].stroke:"stroke:"+u[t.type].stroke+"; fill:"+u[t.type].fill}function m(t,a){return t&&999!=t?Math.pow(2*z-t,1.4):Math.pow(parseInt(a)*z/7,.5)}function y(t){return 999==t.mag&&Math.sqrt(parseInt(t.dim))<w.dsos.namelimit||999!=t.mag&&t.mag>w.dsos.namelimit||""===t.name?void 0:w.dsos.desig&&t.desig?t.desig:t.name}function b(t){return t.mag>w.stars.namelimit||w.stars.desig===!1&&""===t.name?void 0:w.stars.proper&&""!==t.name?t.name:w.stars.desig?t.desig:void 0}function v(t){if(null===t)return.2;var a=z*Math.exp(O*(t+2));return a>.2?a:.2}function M(t){return t.mag>w.stars.limit?"rgba(0,0,0,0)":w.stars.colors?d(t.bv):w.stars.color}var w,k,P;if(w=c.set(a),P=t("map")?"#map":"body",g.hasOwnProperty(w.projection)){var j=g[w.projection],q=w.transform||"equatorial",I=j.ratio||2,A=w.width,x=A/I,z=7,O=-.3,E="galactic"==q?[0,0,0]:[180,0,0],S=r.projection(w.projection).rotate(n[q]).translate([A/2,x/2]).scale([j.scale]),D=r.projection(w.projection).translate([A/2,x/2]).scale([j.scale]);j.clip&&(S.clipAngle(90),k=d3.geo.circle().angle([90]));var G=d3.geo.zoom().projection(S).center([A/2,x/2]).scaleExtent([j.scale,4*j.scale]).on("zoom.redraw",o),F=d3.geo.graticule().minorStep([15,10]),R=d3.geo.path().projection(S),B=d3.geo.path().projection(D),C=d3.select(P).append("svg").attr("width",A).attr("height",x).call(G);k?C.append("path").datum(k).attr("class","outline").attr("d",B).style("fill",w.background):C.append("path").datum(F.outline).attr("class","outline").attr("d",B).style("fill",w.background),w.lines.graticule&&("equatorial"==q?C.append("path").datum(F).attr("class","gridline").attr("d",R):r.graticule(C,R,q)),w.mw.show&&d3.json("data/mw.json",function(t,a){C.selectAll(".mway").data(a.features).enter().append("path").attr("class","mw").attr("d",R)}),w.constellations.show&&(d3.json("data/constellations.json",function(t,a){C.selectAll(".constnames").data(a.features).enter().append("text").attr("class","constname").attr("transform",function(t){return s(t.geometry.coordinates)}).text(function(t){return w.constellations.names?w.constellations.desig?t.properties.desig:t.properties.name:void 0}).style("fill-opacity",function(t){return e(t.geometry.coordinates)})}),w.constellations.bounds&&d3.json("data/constellations.bounds.json",function(t,a){C.selectAll(".bounds").data(a.features).enter().append("path").attr("class","boundaryline").attr("d",R)}),w.constellations.lines&&d3.json("data/constellations.lines.json",function(t,a){C.selectAll(".lines").data(a.features).enter().append("path").attr("class","constline").attr("d",R)})),w.stars.show&&d3.json(w.stars.data,function(t,a){C.selectAll(".stars").data(a.features).enter().append("path").attr("class","star").attr("d",R.pointRadius(function(t){return t.properties?v(t.properties.mag):1})).style("fill",function(t){return M(t.properties)}),w.stars.names&&C.selectAll(".starnames").data(a.features).enter().append("text").attr("transform",function(t){return s(t.geometry.coordinates)}).text(function(t){return b(t.properties)}).attr({dy:"-.5em",dx:".35em","class":"starname"}).style("fill-opacity",function(t){return e(t.geometry.coordinates)})}),w.dsos.show&&d3.json(w.dsos.data,function(t,a){C.selectAll(".dsos").data(a.features).enter().append("path").attr("class",function(t){return"dso "+t.properties.type}).attr("transform",function(t){return s(t.geometry.coordinates)}).attr("d",function(t){return f(t.properties)}).attr("style",function(t){return h(t.properties)}).style("fill-opacity",function(t){return e(t.geometry.coordinates)}).style("stroke-opacity",function(t){return e(t.geometry.coordinates)}),w.dsos.names&&C.selectAll(".dsonames").data(a.features).enter().append("text").attr("class",function(t){return"dsoname "+t.properties.type}).attr("transform",function(t){return s(t.geometry.coordinates)}).text(function(t){return y(t.properties)}).attr({dy:"-.5em",dx:".35em",style:function(t){return h(t.properties,!0)}}).style("fill-opacity",function(t){return e(t.geometry.coordinates)})});for(var H in w.lines)w.lines.hasOwnProperty(H)&&"graticule"!=H&&w.lines[H]!==!1&&C.append("path").datum(d3.geo.circle().angle([90]).origin(l[H])).attr("class",H).attr("d",R)}},r.projection=function(t){var a,e,r;if(!g.hasOwnProperty(t))throw new Error("Projection not supported: "+t);return a=g[t],e=null!==a.arg?d3.geo[t].raw(a.arg):d3.geo[t].raw,r=function(t,a){var r=e(-t,a);return r},r.invert=function(t,a){var r=e.invert(t,a);return r[0]*=-1,r},d3.geo.projection(r)};var n={equatorial:[180,0,0],ecliptic:[180,0,23.4393],galactic:[93.5949,28.9362,-58.5988],supergalactic:[137.31,59.5283,57.7303],mars:[97.5,23.5,29]},l={equatorial:[0,90],ecliptic:[-90,66.5607],galactic:[-167.1405,27.1283],supergalactic:[-76.2458,15.7089],mars:[-42.3186,52.8865]};r.eulerAngles=function(){return n},r.poles=function(){return l};var s=2*Math.PI,i=Math.PI/2,o=Math.PI/180;r.graticule=function(t,e,r){var n;if(r&&"equatorial"!=r){for(n=10;170>=n;n+=10)t.append("path").datum(d3.geo.circle().angle([n]).origin(l[r])).attr("class","gridline").attr("d",e);for(n=10;180>=n;n+=10)t.append("path").datum(d3.geo.circle().angle([90]).origin(a([n,0],f["inverse "+r]))).attr("class","gridline").attr("d",e)}};var f={ecliptic:[-90,23.4393,90],"inverse ecliptic":[90,23.4393,-90],galactic:[192.8595,62.8717,122.9319],"inverse galactic":[238.9319,62.8717,192.8595],supergalactic:[283.7542,74.2911,26.4504],"inverse supergalactic":[334.4504,74.2911,283.7542],init:function(){for(var t in this)this[t].constructor==Array&&(this[t]=this[t].map(function(t){return t*o}))},add:function(t,a){return a&&t&&3===a.length&&!this.hasOwnProperty(t)?(this[t]=a.map(function(t){return t*o}),this[t]):void 0}};f.init(),r.euler=function(){return f};var c={width:1024,projection:"aitoff",transform:"equatorial",background:"#000",stars:{show:!0,limit:6,colors:!0,color:"#fff",names:!0,proper:!1,desig:!0,namelimit:2,data:"data/stars.6.json"},dsos:{show:!0,limit:6,names:!0,desig:!0,namelimit:4,data:"data/dsos.bright.json"},constellations:{show:!0,names:!0,desig:!0,lines:!0,bounds:!1},mw:{show:!0},lines:{graticule:!0,equatorial:!1,ecliptic:!0,galactic:!1,supergalactic:!1,mars:!1},set:function(t){var a,e,r={};if(!t)return this;for(a in this)if(this.hasOwnProperty(a)&&"function"!=typeof this[a])if(t.hasOwnProperty(a)&&null!==t[a])if(this[a].constructor!=Object)r[a]=t[a];else{r[a]={};for(e in this[a])r[a][e]=t[a].hasOwnProperty(e)?t[a][e]:this[a][e]}else r[a]=this[a];return r}};r.settings=function(){return c};var u={gg:{shape:"circle",stroke:"#f00",fill:"#f00"},g:{shape:"ellipse",stroke:"#f00",fill:"#f00"},s:{shape:"ellipse",stroke:"#f00",fill:"#f00"},s0:{shape:"ellipse",stroke:"#f00",fill:"#f00"},sd:{shape:"ellipse",stroke:"#f00",fill:"#f00"},e:{shape:"ellipse",stroke:"#f00",fill:"#f00"},i:{shape:"ellipse",stroke:"#f00",fill:"#f00"},oc:{shape:"circle",stroke:"#fc0",fill:"none"},gc:{shape:"circle",stroke:"#f90",fill:"#f90"},en:{shape:"square",stroke:"#f0c",fill:"#f0c"},bn:{shape:"square",stroke:"#f0c",fill:"none"},sfr:{shape:"square",stroke:"#c0f",fill:"none"},rn:{shape:"square",stroke:"#00f",fill:"#00f"},pn:{shape:"diamond",stroke:"#0cc",fill:"#0cc"},snr:{shape:"diamond",stroke:"#f0c",fill:"#f0c"},dn:{shape:"square",stroke:"#999",fill:"none"},pos:{shape:"marker",stroke:"#ccc",fill:"none"}},d=d3.scale.quantize().domain([3.347,-.335]).range(["#ff4700","#ff4b00","#ff4f00","#ff5300","#ff5600","#ff5900","#ff5b00","#ff5d00","#ff6000","#ff6300","#ff6500","#ff6700","#ff6900","#ff6b00","#ff6d00","#ff7000","#ff7300","#ff7500","#ff7800","#ff7a00","#ff7c00","#ff7e00","#ff8100","#ff8300","#ff8506","#ff870a","#ff8912","#ff8b1a","#ff8e21","#ff9127","#ff932c","#ff9631","#ff9836","#ff9a3c","#ff9d3f","#ffa148","#ffa34b","#ffa54f","#ffa753","#ffa957","#ffab5a","#ffad5e","#ffb165","#ffb269","#ffb46b","#ffb872","#ffb975","#ffbb78","#ffbe7e","#ffc184","#ffc489","#ffc78f","#ffc892","#ffc994","#ffcc99","#ffce9f","#ffd1a3","#ffd3a8","#ffd5ad","#ffd7b1","#ffd9b6","#ffdbba","#ffddbe","#ffdfc2","#ffe1c6","#ffe3ca","#ffe4ce","#ffe8d5","#ffe9d9","#ffebdc","#ffece0","#ffefe6","#fff0e9","#fff2ec","#fff4f2","#fff5f5","#fff6f8","#fff9fd","#fef9ff","#f9f6ff","#f6f4ff","#f3f2ff","#eff0ff","#ebeeff","#e9edff","#e6ebff","#e3e9ff","#e0e7ff","#dee6ff","#dce5ff","#d9e3ff","#d7e2ff","#d3e0ff","#c9d9ff","#bfd3ff","#b7ceff","#afc9ff","#a9c5ff","#a4c2ff","#9fbfff","#9bbcff"]),g={airy:{arg:Math.PI/2,scale:360,ratio:1,clip:!0},aitoff:{arg:null,scale:162},armadillo:{arg:0,scale:250},august:{arg:null,scale:94,ratio:1.4},azimuthalEqualArea:{arg:null,scale:220,ratio:1,clip:!0},azimuthalEquidistant:{arg:null,scale:150,ratio:1,clip:!0},baker:{arg:null,scale:160,ratio:1.4},berghaus:{arg:1,scale:320,ratio:1,clip:!0},boggs:{arg:null,scale:170},bonne:{arg:Math.PI/4,scale:230,ratio:.88},bromley:{arg:null,scale:162},collignon:{arg:null,scale:100,ratio:2.6},craig:{arg:0,scale:310,ratio:1.5,clip:!0},craster:{arg:null,scale:160},cylindricalEqualArea:{arg:Math.PI/6,scale:180},cylindricalStereographic:{arg:Math.PI/4,scale:230,ratio:1.3},eckert1:{arg:null,scale:175},eckert2:{arg:null,scale:175},eckert3:{arg:null,scale:190},eckert4:{arg:null,scale:190},eckert5:{arg:null,scale:182},eckert6:{arg:null,scale:182},eisenlohr:{arg:null,scale:102},equirectangular:{arg:null,scale:160},fahey:{arg:null,scale:196,ratio:1.4},foucaut:{arg:null,scale:142},ginzburg4:{arg:null,scale:180,ratio:1.7},ginzburg5:{arg:null,scale:196,ratio:1.55},ginzburg6:{arg:null,scale:190,ratio:1.4},ginzburg8:{arg:null,scale:205,ratio:1.3},ginzburg9:{arg:null,scale:190,ratio:1.4},gringorten:{arg:null,scale:360,ratio:1,clip:!0},hammer:{arg:2,scale:180},hatano:{arg:null,scale:186},healpix:{arg:1,scale:300,ratio:1.2},hill:{arg:2,scale:190,ratio:1.6},homolosine:{arg:null,scale:160,ratio:2.2},kavrayskiy7:{arg:null,scale:185,ratio:1.75},lagrange:{arg:Math.PI/2,scale:88,ratio:1.7,clip:!0},larrivee:{arg:null,scale:160,ratio:1.25},laskowski:{arg:null,scale:165,ratio:1.7},loximuthal:{arg:Math.PI/4,scale:170,ratio:1.8},mercator:{arg:null,scale:160,ratio:1.3},miller:{arg:null,scale:160,ratio:1.5},mollweide:{arg:null,scale:180},mtFlatPolarParabolic:{arg:null,scale:175},mtFlatPolarQuartic:{arg:null,scale:230,ratio:1.65},mtFlatPolarSinusoidal:{arg:null,scale:175,ratio:1.9},naturalEarth:{arg:null,scale:185,ratio:1.85},nellHammer:{arg:null,scale:160,ratio:2.6},orthographic:{arg:null,scale:480,ratio:1,clip:!0},patterson:{arg:null,scale:160,ratio:1.75},polyconic:{arg:null,scale:160,ratio:1.3},rectangularPolyconic:{arg:0,scale:160,ratio:1.65},robinson:{arg:null,scale:160},sinusoidal:{arg:null,scale:160,ratio:2},stereographic:{arg:null,scale:480,ratio:1,clip:!0},times:{arg:null,scale:210,ratio:1.4},twoPointEquidistant:{arg:Math.PI/2,scale:320,ratio:1.15,clip:!0},vanDerGrinten:{arg:null,scale:160,ratio:1},vanDerGrinten2:{arg:null,scale:160,ratio:1},vanDerGrinten3:{arg:null,scale:160,ratio:1},vanDerGrinten4:{arg:null,scale:160,ratio:1.6},wagner4:{arg:null,scale:185},wagner6:{arg:null,scale:160},wagner7:{arg:null,scale:190,ratio:1.8},wiechel:{arg:null,scale:360,ratio:1,clip:!0},winkel3:{arg:null,scale:196,ratio:1.7}};r.projections=function(){return g};var p=d3.map({ellipse:function(t){var a=Math.sqrt(t),e=.666*a,r=a/3;return"M"+-e+","+-r+" m"+-e+",0 a"+e+","+r+" 0 1,0"+2*e+",0 a"+e+","+r+" 0 1,0"+-(2*e)+",0"},marker:function(t){var a=t>48?t/4:12,e=a/2,r=e-3;return"M "+-e+" 0 h "+r+" M 0 "+-e+" v "+r+" M "+e+" 0 h "+-r+" M 0 "+e+" v "+-r}});d3.svg.customSymbol=function(){function t(t,r){return p.get(a.call(this,t,r))(e.call(this,t,r))}var a,e=64;return t.type=function(e){return arguments.length?(a=d3.functor(e),t):a},t.size=function(a){return arguments.length?(e=d3.functor(a),t):e},t},this.Celestial=r}();