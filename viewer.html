<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <title>D3 Starmap</title>
  <script type="text/javascript" src="lib/d3.min.js"></script>
  <script type="text/javascript" src="lib/d3.geo.zoom.js"></script>
  <script type="text/javascript" src="lib/d3.geo.projection.min.js"></script>
  <script type="text/javascript" src="celestial.js"></script>
  <link rel="stylesheet" href="style.css">
</head><body>
<div id="map"></div>
<form id="params" name="params" method="get" action="#">
  <div class="col">
  <!-- projection, transform, size, center?-->
  <label>Width<input type="number" maxlength="4" name="width" value="1024" /> px</label>&nbsp;&nbsp;
  <label>Projection <select name="projection" id="projection"></select></label>&nbsp;&nbsp;
  <label>Coordinates <select name="transform" id="transform"></select></label>
  </div>
  <div class="col">
  <!-- stars -->
  <label><strong>Stars</strong> <input type="checkbox" name="stars-show" value="true" checked="checked" /></label>
  <label>down to magnitude<input type="number" name="stars-limit" value="6" max="6" min="-1"></label>
  <label>with spectral colors<input type="checkbox" name="stars-colors" value="true" checked="checked"> </label>
  <label>or default color <input type="color" name="stars-color" value="#ffffff"> </label><br>
  <label>Show names<input type="checkbox" name="stars-names" value="true" checked="checked"> </label> 
  <label>proper names (if any)<input type="checkbox" name="stars-proper" value="true" checked=""> </label> 
  <label>or designations<input type="checkbox" name="stars-desig" value="true" checked="checked"> </label>
  <label>down to mag<input type="number" name="stars-namelimit" value="2" max="6" min="-1"></label>
  </div>  
  <div class="col">
  <!-- dsos -->
  <label><strong>DSOs</strong> <input type="checkbox" name="dsos-show" value="true" checked="checked"> </label>
  <label>down to mag<input type="number" name="dsos-limit" value="6" max="6" min="-1"></label>
  <label>with names<input type="checkbox" name="dsos-names" value="true" checked="checked"> </label>
  <label>or designations<input type="checkbox" name="dsos-desig" value="true" checked="checked"> </label>
  <label>down to mag<input type="number" name="dsos-namelimit" value="6" max="6" min="-1"> mag </label>
  </div>  
  <div class="col">
  <!-- constellations -->
  <label><strong>Constellations</strong> <input type="checkbox" name="constellations-show" checked> </label>
  <label>with names<input type="checkbox" name="constellations-names" value="true" checked="checked"> </label>
  <label>abbreviated<input type="checkbox" name="constellations-desig" value="true" checked="checked"> </label>
  <label>with lines<input type="checkbox" name="constellations-lines" value="true" checked="checked"> </label>
  <label>with boundaries<input type="checkbox" name="constellations-bounds" value="1"> </label>
  </div>  
  <div class="col">
  <!-- graticules & planes -->
  <strong>Lines</strong>
  <label>Graticule<input type="checkbox" name="lines-graticule" value="true" checked> </label>&nbsp;&nbsp;
  <label>Equator<input type="checkbox" name="lines-equatorial" value="true"> </label>
  <label>Ecliptic<input type="checkbox" name="lines-ecliptic" value="true" checked="checked"> </label>
  <label>Galactic plane<input type="checkbox" name="lines-galactic" value="true"> </label>
  <label>Supergal. plane<input type="checkbox" name="lines-supergalactic" value="true"> </label>
  </div>  
  <div class="col">
  <strong>Other</strong>
  <label>Milky Way<input type="checkbox" name="mw-show" value="true" checked="checked"> </label>&nbsp;&nbsp;
  <label> Background color <input type="color" name="background" value="#000"> </label>
  </div>
  <input type="submit" value="Show">&nbsp;&nbsp;
  <input type="reset" value="Reset">
</form>
</div>

<script type="text/javascript">
/* D3-Celestial sky map
   Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
*/
/*  Uncomment for deeper data files */
//var stardata = "data6/stars.8.5.json";
//var dsodata = "data/dsos.14.json";

var cfg = parseQuery();

fillOptions();
if (cfg) {
  cfg = fillForm(cfg);
  cfg = settings.set(objectify(cfg));
} else {
  cfg = settings.set();
}
enableForm();      

if (stardata) cfg.stars.data = stardata;
if (dsodata) cfg.dsos.data = dsodata;

 
Celestial.display(cfg);

//Form
function fillForm(cfg) {
  var i, e = document.forms[0].elements;

  for (i=0; i<e.length; i++) {
    if (e[i].type == "checkbox") { 
      if (cfg.hasOwnProperty(e[i].name)) {
        e[i].checked = true;
        cfg[e[i].name] = true;
      } else { 
        e[i].checked = false;
        cfg[e[i].name] = false;
      } 
    }
    else if (e[i].type == "select-one") { selectOption(e[i], cfg[e[i].name]); }
    else if (e[i].type == "number") { e[i].value = parseFloat(cfg[e[i].name]); }
    else if (cfg.hasOwnProperty(e[i].name)) { e[i].value = cfg[e[i].name]; }
  }    
  return cfg;
}

function enableForm() {
  var t, i, key, f = document.forms[0],
  deps = {
    "stars-limit": "stars-show",
    "stars-names": "stars-show",
    "stars-proper": "stars-show,stars-names",
    "stars-desig": "stars-show,stars-names",
    "stars-namelimit": "stars-show,stars-names",
    "stars-colors": "stars-show",
    "stars-color": "stars-show",
    "dsos-limit": "dsos-show",
    "dsos-names": "dsos-show",
    "dsos-desig": "dsos-show,dsos-names",
    "dsos-namelimit": "dsos-show,dsos-names",
    "constellations-names": "constellations-show",
    "constellations-desig": "constellations-show,constellations-names",
    "constellations-lines": "constellations-show",
    "constellations-bounds": "constellations-show"
  };

  for (key in deps) {
    if (!deps.hasOwnProperty(key)) continue;
    t = deps[key].split(",");
    f[key].disabled = t.some( function(d) { return !f[d].checked; } );
    f[key].parentNode.style.color = f[key].disabled ? "#999" : "#000";
  }
}


function selectOption(e, opt) {
  var i;
  for (i=0; i<e.options.length; i++) {
    if (e.options[i].value == opt) {
      e.selectedIndex = i;
      return;
    }
  }
}

function fillOptions() {
  var lim, i, key, e = document.forms[0].elements;
      proj = $(),
      trans = $("transform");
      
  $("params").action = document.location.href.replace(/\?.*/, "");
  
  fillSelect("projection", projections);
  fillSelect("transform", eulerAngles);
  
  lim = getLimits();
  
  for (i=0; i<e.length; i++) {
    e[i].onchange = enableForm;
  }
}

function getLimits() {
  var t, rx = /\d+(\.\d+)?/g,
      s, d, res = {s:6, d:6};
  if (dsodata) d = dsodata;
  else d = = settings.dsos.data;
  
  //test d
  t = d.match(rx);
  if (t !== null) {
    res.d = parseFloat(t[t.length-1]);
  }
   

  if (stardata) s = stardata;
  else s = settings.stars.data;
  
  //test s
  t = s.match(rx);
  if (t !== null) {
    res.s = parseFloat(t[t.length-1]);
  }
  return res;
}

function fillSelect(id, fill) {
  var t, key, elem = $(id);
  
  if (!elem || !fill) return;
        
  for (key in fill) {
    t = document.createElement("option");
    t.value = key;
    t.innerHTML = key;
    if (key == settings[id]) t.selected = "selected";
    elem.appendChild(t);
  }

}

function parseQuery() {
  if (!location.search) return;
  var i, t, res = {}, cfg = location.search.replace(/^\?/, "").split('&');

  for (i=0; i<cfg.length; i++) {
    t = cfg[i].split('=', 2).map( function(str) { return unescape(str) } );
    res[t[0]] = t.length > 1 ? t[1] : null;
  }
  return res;
}

function objectify(cfg) {
  var t, key, prop, res = {};
  for (key in cfg) {
    if (!cfg.hasOwnProperty(key)) continue;
    t = key.split('-');
    prop = t[0];
    if (t.length == 1) {
      res[prop] = cfg[key];
    } else {
      if (!res[prop]) { res[prop] = {}; }
      res[prop][t[1]] = cfg[key]; 
    }
  }
  return res;
}

  </script>
  </body>
</html>